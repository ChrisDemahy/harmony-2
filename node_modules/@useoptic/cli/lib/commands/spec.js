"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const command_1 = require("@oclif/command");
const cli_client_1 = require("@useoptic/cli-client");
const cli_config_1 = require("@useoptic/cli-config");
const cli_server_1 = require("@useoptic/cli-server");
const paths_1 = require("../shared/paths");
const colors_1 = tslib_1.__importDefault(require("colors"));
const openBrowser_1 = tslib_1.__importDefault(require("react-dev-utils/openBrowser"));
const cli_shared_1 = require("@useoptic/cli-shared");
const analytics_1 = require("../shared/analytics");
const config_1 = require("../config");
class Spec extends command_1.Command {
    async run() {
        let paths;
        let config;
        try {
            paths = await cli_config_1.getPathsRelativeToConfig();
            config = await cli_config_1.readApiConfig(paths.configPath);
        }
        catch (e) {
            cli_shared_1.userDebugLogger(e);
            this.log(cli_shared_1.fromOptic(`No optic.yml file found. Add Optic to your API by running ${colors_1.default.bold('api init')}`));
            process.exit(0);
        }
        cli_shared_1.developerDebugLogger(paths);
        await this.helper(paths.cwd, config);
    }
    async helper(basePath, config) {
        const daemonState = await cli_server_1.ensureDaemonStarted(paths_1.lockFilePath, config_1.Config.apiBaseUrl);
        const apiBaseUrl = `http://localhost:${daemonState.port}/api`;
        cli_shared_1.developerDebugLogger(`api base url: ${apiBaseUrl}`);
        const cliClient = new cli_client_1.Client(apiBaseUrl);
        cliClient.setIdentity(await analytics_1.getUser());
        const cliSession = await cliClient.findSession(basePath, null, null);
        cli_shared_1.developerDebugLogger({ cliSession });
        const uiBaseUrl = cli_shared_1.makeUiBaseUrl(daemonState);
        const uiUrl = `${uiBaseUrl}/apis/${cliSession.session.id}/dashboard`;
        openBrowser_1.default(uiUrl);
        cli_shared_1.cleanupAndExit();
    }
}
exports.default = Spec;
Spec.description = 'Open your Optic API specification';
